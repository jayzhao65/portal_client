# 开发计划文档

## 项目概述

基于现有的 `yilore_sever` 后端，在工作台前端添加"流程测试"功能，完全模拟iOS的完整占卜流程，每一步输入输出都清晰可见，用于prompt调整和模型测试。

## 现状分析

### 1. 现有基础
- ✅ **后端API**: `yilore_sever` 已有完整的API体系
- ✅ **开发模式认证**: 已配置好，可以绕过JWT验证
- ✅ **前端框架**: `yilore_doc/oracle/portal_client` 已有React + TypeScript + Ant Design基础
- ✅ **数据库连接**: Supabase连接正常，开发用户已创建

### 2. 已完成的工作
- ✅ **Prompt配置管理页面**: 已创建 `PromptConfig.tsx` 页面
- ✅ **后端服务**: 已实现 `prompt_config_service.py` 和 `prompt_configs.py` API
- ✅ **数据库表**: 已创建 `prompt_configs` 表，支持5个阶段（包括"追问"）
- ✅ **模型集成**: 已集成 `ai_models.py` 中的模型列表到前端下拉选择
- ✅ **前端路由**: 已在 `App.tsx` 中添加 Prompt配置 菜单项和路由
- ✅ **表单功能**: 支持新增、编辑、查看、删除、激活Prompt配置
- ✅ **占位符管理**: 支持各阶段的占位符配置和验证
- ✅ **模型配置**: 支持 `max_tokens` 和 `temperature` 参数配置

### 3. 认证机制
- **开发模式认证**: 使用 `X-Dev-Mode: true` 和 `X-Dev-Token: dev-secret-2024`
- **测试用户ID**: `0e86f7ad-6737-4332-9f9b-fc83ace7a864`
- **不影响现有**: 生产环境的认证逻辑完全不受影响

## 功能需求

### 1. 核心目标
创建一个开发测试工作台，完全模拟iOS的完整流程，每一步输入输出都清晰可见，用于prompt调整和模型测试。

### 2. 功能模块

#### 模块1: 问题验证测试 ✅ 已完成
- **用户标签**: 直接从数据库获取，显示在界面上（文本框显示空白即可）
- **问题输入**: 问题文本输入框
- **模型选择**: 完全保持与现有 `QuestionClarify.tsx` 一致
- **Prompt配置**: 从后端获取固定Prompt，可编辑，占位符部分标注出来
- **输出**: 显示Raw JSON结果

#### 模块2: 占卜计算测试 🔄 待开发
- **爻状态选择**: 手动选择6个爻的状态（老阳/老阴/少阳/少阴）
- **卦象计算**: 调用占卜计算API
- **结果展示**: 显示本卦、之卦、变爻等信息

#### 模块3: 现状分析测试 🔄 待开发
- **占卜结果输入**: 使用上一步的占卜结果
- **AI分析过程**: 调用现状分析API
- **分析结果**: 显示现状分析内容

#### 模块4: 解读生成测试 🔄 待开发
- **完整数据整合**: 整合前面所有步骤的数据
- **AI解读过程**: 调用解读生成API
- **最终报告**: 显示完整的占卜解读报告

#### 模块5: 追问测试 🔄 待开发
- **追问输入**: 基于之前分析结果的追问
- **AI追问处理**: 调用追问API
- **追问结果**: 显示追问的解答

### 3. 技术需求

#### 前端技术
- **框架**: 基于现有的React + TypeScript + Ant Design
- **状态管理**: 管理整个测试流程的状态
- **API调用**: 调用 `yilore_sever` 的API（使用开发模式认证）
- **数据展示**: 清晰展示每一步的输入输出

#### 后端集成
- **API调用**: 复用现有的所有API接口
- **认证方式**: 使用开发模式认证（X-Dev-Mode + X-Dev-Token）
- **数据流**: 保持与iOS端一致的数据流

## 页面设计

### 1. 整体布局
- **位置**: 在现有工作台的最前面，添加两个标签页
- **标签页1**: "流程测试" - 用于测试完整流程 🔄 待开发
- **标签页2**: "Prompt管理" - 用于管理所有阶段的Prompt和模型配置 ✅ 已完成
- **布局**: 两个独立页面，功能分离

### 2. 流程测试页面布局

#### 页面结构
```
Tabs {
  Tab1: "流程测试"
  Tab2: "Prompt管理"
}

流程测试页面内容:
VStack {
  HStack { 问题输入区域, 确认按钮 }
  HStack {
    VStack { 模型选择、prompt显示、placeholder显示 }
    输出内容（raw JSON）
  }
}
```

#### 问题验证模块布局
- **整体**: 整个模块放在一个卡片背景中
- **问题输入**: 文本框 + 确认按钮
- **配置区域**: 模型选择、Prompt显示、Placeholder标注
- **输出区域**: 直接显示Raw JSON

### 3. Prompt管理页面布局 ✅ 已完成

#### 页面结构
```
VStack {
  HStack { 页面标题, 全局操作按钮 }
  
  // 每个阶段的配置卡片
  Grid {
    Card1: 问题验证配置
    Card2: 扩写/位置生成配置  
    Card3: 现状分析配置
    Card4: 占卜解读配置
    Card5: 追问配置
  }
}
```

#### 每个阶段卡片的内容 ✅ 已完成
```
Card {
  Header: {
    阶段名称 (写死)
    当前状态 (线上版本/未激活)
  }
  
  Body: {
    System Prompt (可编辑)
    User Prompt (可编辑)
    占位符列表 (只读显示)
    模型信息 (模型名称 + 提供商)
    模型配置 (max_tokens, temperature)
  }
  
  Actions: {
    编辑按钮
    激活按钮 (设为线上版本)
    删除按钮
    查看按钮
  }
}
```

#### 新增/编辑表单 ✅ 已完成
```
Modal {
  Form {
    阶段名称 (下拉选择)
    版本号 (输入框)
    System Prompt (文本域)
    User Prompt (文本域)
    模型名称 (下拉选择，从ai_models.py获取)
    模型配置 (max_tokens, temperature)
    占位符 (只读显示)
  }
  
  Actions: {
    保存按钮
    取消按钮
  }
}
```

## Prompt和模型配置管理

### 1. 系统架构（简化版）

#### 数据库设计
```
prompt_configs表:
├── id (UUID, 主键)
├── stage_name (阶段名称，如"问题验证"、"占卜计算"、"现状分析")
├── system_prompt (系统提示词)
├── user_prompt (用户提示词模板)
├── placeholders (占位符列表，JSON格式)
├── model_name (模型名称，如"Claude Sonnet 4")
├── provider (提供商，绑定死，如"openrouter")
├── is_active (是否线上版本)
├── created_at (创建时间)
└── updated_at (更新时间)
```

### 2. 页面设计
- **单页面**: 一个页面搞定所有配置
- **阶段卡片**: 每个阶段一个卡片，一目了然
- **操作简单**: 新增、激活两步搞定
- **即时生效**: 激活后立即生效，无需重启

### 3. 每个阶段的卡片内容

#### 卡片头部
- **阶段名称** (写死，如"问题验证")
- **当前状态** (显示"线上版本"或"未激活")

#### 卡片主体
- **System Prompt**: 显示当前使用的系统提示词
- **User Prompt**: 显示用户提示词模板
- **占位符列表**: 显示可用的占位符和正确拼写
- **模型信息**: 显示模型名称和提供商

#### 卡片操作
- **新增配置**: 打开新增/编辑表单
- **激活**: 设为线上版本（自动取消其他配置的激活状态）

### 4. 占位符配置

#### 问题验证阶段
```json
{
  "placeholders": [
    {"key": "{user_tags}", "description": "用户标签"},
    {"key": "{question}", "description": "用户问题"}
  ]
}
```

#### 占卜计算阶段
```json
{
  "placeholders": [
    {"key": "{reading_id}", "description": "Reading记录ID"},
    {"key": "{yao_states}", "description": "爻状态列表"}
  ]
}
```

#### 现状分析阶段
```json
{
  "placeholders": [
    {"key": "{reading_id}", "description": "Reading记录ID"},
    {"key": "{divination_result}", "description": "占卜结果"}
  ]
}
```

#### 解读生成阶段
```json
{
  "placeholders": [
    {"key": "{reading_id}", "description": "Reading记录ID"},
    {"key": "{situation_analysis}", "description": "现状分析结果"}
  ]
}
```

## 开发优先级

### 第一阶段（核心功能）✅ 已完成
1. ✅ 问题验证测试模块
2. ✅ 基本的流程控制
3. ✅ Prompt和模型配置管理页面

### 第二阶段（完善功能）🔄 进行中
1. 🔄 占卜计算测试模块
2. 🔄 现状分析测试模块
3. 🔄 解读生成测试模块
4. 🔄 追问测试模块

### 第三阶段（高级功能）⏳ 待开始
1. ⏳ 测试历史记录
2. ⏳ 结果对比分析
3. ⏳ 批量测试功能

## 技术实现要点

### 1. 保持一致性
- **UI组件**: 完全复用现有的Card、Row、Col、Button等
- **状态管理**: 复用现有的useState、useEffect等
- **API调用**: 复用现有的fetch逻辑和错误处理
- **样式**: 保持完全一致的CSS样式

### 2. 简化功能
- **用户标签**: 只显示，不编辑
- **问题输入**: 只保留文本输入框
- **模型选择**: 完全一致
- **Prompt**: 可编辑，但保持原有结构

### 3. 认证集成
- **开发模式**: 使用 `X-Dev-Mode: true` 和 `X-Dev-Token: dev-secret-2024`
- **API调用**: 所有API调用都使用开发模式认证
- **用户绑定**: 使用固定的开发用户ID

## 注意事项

1. **不要在生产环境使用**: 开发模式认证仅用于开发测试
2. **不影响现有功能**: 所有现有用户认证正常工作
3. **最小化修改**: 只添加必要的功能，不破坏现有架构
4. **数据安全**: 测试数据与生产数据分离

## 两个核心页面详细设计

### 页面1: 流程测试页面

#### 功能描述
- **目的**: 完全模拟iOS的完整占卜流程，每一步输入输出都清晰可见
- **用途**: 用于prompt调整和模型测试，验证整个流程的正确性

#### 页面内容
1. **问题验证测试模块**
   - 问题输入框 + 确认按钮
   - 当前使用的模型和Prompt显示
   - 占位符说明（如{user_tags}, {question}）
   - 输出结果（Raw JSON）

2. **占卜计算测试模块**
   - 6个爻的状态选择器（老阳/老阴/少阳/少阴）
   - 计算按钮
   - 占卜结果展示（本卦、之卦、变爻等）

3. **现状分析测试模块**
   - 使用上一步的占卜结果
   - 分析按钮
   - 现状分析结果展示

4. **解读生成测试模块**
   - 整合前面所有步骤的数据
   - 生成按钮
   - 完整解读报告展示

#### 技术特点
- 使用开发模式认证调用 `yilore_sever` API
- 每一步的结果都会保存到状态中，供下一步使用
- 所有输出都显示Raw JSON，便于调试

### 页面2: Prompt管理页面

#### 功能描述
- **目的**: 管理所有阶段的Prompt和模型配置
- **用途**: 让开发者可以随时调整Prompt和模型，无需修改代码

#### 页面内容
1. **问题验证配置卡片**
   - 阶段名称：问题验证
   - System Prompt（可编辑）
   - User Prompt（可编辑）
   - 占位符列表：{user_tags}, {question}
   - 模型信息：模型名称 + 提供商
   - 操作：编辑、激活、删除

2. **占卜计算配置卡片**
   - 阶段名称：占卜计算
   - System Prompt（可编辑）
   - User Prompt（可编辑）
   - 占位符列表：{reading_id}, {yao_states}
   - 模型信息：模型名称 + 提供商
   - 操作：编辑、激活、删除

3. **现状分析配置卡片**
   - 阶段名称：现状分析
   - System Prompt（可编辑）
   - User Prompt（可编辑）
   - 占位符列表：{reading_id}, {divination_result}
   - 模型信息：模型名称 + 提供商
   - 操作：编辑、激活、删除

4. **解读生成配置卡片**
   - 阶段名称：解读生成
   - System Prompt（可编辑）
   - User Prompt（可编辑）
   - 占位符列表：{reading_id}, {situation_analysis}
   - 模型信息：模型名称 + 提供商
   - 操作：编辑、激活、删除

#### 技术特点
- 每个阶段只能有一个激活的配置
- 激活后立即生效，无需重启服务
- 支持新增、编辑、删除、激活操作
- 所有配置都存储在数据库中

## 下一步行动

### 已完成 ✅
1. ✅ **启动前端工作台**: 确保现有工作台能正常运行
2. ✅ **创建流程测试页面**: 实现问题验证测试模块
3. ✅ **实现Prompt配置管理页面**: 创建可配置的Prompt系统
4. ✅ **集成测试**: 测试完整的流程

### 下一步计划 🔄
1. 🔄 **创建流程测试页面**: 实现完整的5阶段测试流程
2. 🔄 **集成占卜计算**: 添加爻状态选择和卦象计算功能
3. 🔄 **集成现状分析**: 添加AI现状分析功能
4. 🔄 **集成解读生成**: 添加完整的占卜解读功能
5. 🔄 **集成追问功能**: 添加基于分析结果的追问功能

### 技术债务 ⚠️
1. ⚠️ **config字段保存问题**: 需要解决表单中config字段的保存问题
2. ⚠️ **占位符格式统一**: 需要确保数据库中所有占位符都是统一格式

---

## 当前状态总结

### 已完成的核心功能
1. **Prompt配置管理页面** - 完全可用的配置管理界面
2. **5阶段Prompt配置** - 支持问题验证、扩写/位置生成、现状分析、占卜解读、追问
3. **模型集成** - 从 `ai_models.py` 自动获取可用模型列表
4. **版本管理** - 支持多版本配置，只能激活一个版本
5. **完整CRUD操作** - 新增、编辑、查看、删除、激活功能

### 技术架构
- **后端**: FastAPI + PostgreSQL (Supabase)
- **前端**: React + TypeScript + Ant Design
- **认证**: 开发模式认证 (X-Dev-Mode + X-Dev-Token)
- **数据流**: 完整的API集成，支持实时配置更新

### 下一步重点
1. **解决config字段保存问题** - 确保模型参数能正确保存
2. **开发流程测试页面** - 实现完整的5阶段测试流程
3. **集成现有API** - 连接占卜计算、现状分析等现有功能

---

*文档创建时间: 2024-08-21*
*最后更新: 2024-08-21*
*当前状态: Prompt管理页面已完成，流程测试页面待开发*
